# AI 工具集 Docker 部署指南

## 📋 概述

本项目使用 Docker 和 Docker Compose 进行容器化部署，支持前端(Next.js)和后端(Flask)的完整部署。

## 🏗️ 架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│     Nginx       │    │   Frontend      │    │    Backend      │
│   (反向代理)     │────│   (Next.js)     │────│    (Flask)      │
│   Port: 443     │    │   Port: 3003    │    │   Port: 8003    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🚀 快速部署

### 1. 环境要求

- Docker 20.10+
- Docker Compose 2.0+
- 服务器内存: 最少 2GB 推荐 4GB
- 磁盘空间: 最少 5GB

### 2. 克隆项目

```bash
git clone <your-repo-url>
cd ai-tools
```

### 3. 一键部署

```bash
# 给部署脚本执行权限
chmod +x deploy.sh

# 完整部署（构建镜像 + 启动服务）
./deploy.sh deploy
```

### 4. 检查服务状态

```bash
# 查看服务状态
./deploy.sh status

# 健康检查
./deploy.sh health

# 查看日志
./deploy.sh logs
```

## 🔧 详细部署步骤

### 1. 构建 Docker 镜像

```bash
# 构建所有镜像
./deploy.sh build

# 或者手动构建
docker-compose build --no-cache
```

### 2. 启动服务

```bash
# 启动所有服务
./deploy.sh up

# 或者手动启动
docker-compose up -d
```

### 3. 配置 Nginx

#### 安装 Nginx (如果未安装)

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

#### 配置站点

```bash
# 复制Nginx配置文件
sudo cp nginx.conf /etc/nginx/sites-available/ai.jarvismedical.asia

# 创建软链接
sudo ln -s /etc/nginx/sites-available/ai.jarvismedical.asia /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 4. SSL 证书配置

#### 使用 Let's Encrypt (推荐)

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d ai.jarvismedical.asia

# 自动续期
sudo crontab -e
# 添加以下行:
# 0 12 * * * /usr/bin/certbot renew --quiet
```

#### 手动 SSL 证书

如果您有自己的 SSL 证书，请将证书文件放置在：

- 证书文件: `/etc/ssl/certs/ai.jarvismedical.asia.crt`
- 私钥文件: `/etc/ssl/private/ai.jarvismedical.asia.key`

## 📊 服务管理

### 常用命令

```bash
# 查看服务状态
./deploy.sh status

# 重启服务
./deploy.sh restart

# 停止服务
./deploy.sh down

# 查看实时日志
./deploy.sh logs

# 健康检查
./deploy.sh health

# 清理资源
./deploy.sh cleanup
```

### Docker Compose 命令

```bash
# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs -f [service_name]

# 重启特定服务
docker-compose restart [service_name]

# 进入容器
docker-compose exec [service_name] bash
```

## 🔍 故障排除

### 1. 服务无法启动

```bash
# 查看详细日志
docker-compose logs

# 检查端口占用
sudo netstat -tulpn | grep :3003
sudo netstat -tulpn | grep :8003

# 检查Docker状态
sudo systemctl status docker
```

### 2. 前端无法访问后端

```bash
# 检查网络连接
docker network ls
docker network inspect ai-tools_ai-tools-network

# 检查环境变量
docker-compose exec frontend env | grep API
```

### 3. Nginx 代理错误

```bash
# 检查Nginx配置
sudo nginx -t

# 查看Nginx日志
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/ai.jarvismedical.asia.error.log

# 检查上游服务
curl http://localhost:3003/health
curl http://localhost:8003/health
```

### 4. SSL 证书问题

```bash
# 检查证书有效期
openssl x509 -in /etc/ssl/certs/ai.jarvismedical.asia.crt -text -noout

# 测试SSL连接
openssl s_client -connect ai.jarvismedical.asia:443
```

## 📈 性能优化

### 1. Docker 优化

```bash
# 清理无用镜像
docker system prune -a

# 限制容器资源
# 在docker-compose.yml中添加:
# deploy:
#   resources:
#     limits:
#       memory: 512M
#       cpus: '0.5'
```

### 2. Nginx 优化

```nginx
# 在nginx.conf中调整以下参数:
worker_processes auto;
worker_connections 1024;
keepalive_timeout 65;
client_max_body_size 10M;
```

### 3. 应用优化

- 前端: 启用 Next.js 的静态导出和缓存
- 后端: 配置 Flask 的生产环境设置
- 数据库: 如果使用数据库，配置连接池

## 🔐 安全配置

### 1. 防火墙设置

```bash
# 只允许必要端口
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS
sudo ufw enable
```

### 2. 容器安全

- 使用非 root 用户运行容器
- 定期更新基础镜像
- 扫描镜像漏洞

### 3. 数据备份

```bash
# 备份脚本示例
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
docker-compose exec backend tar -czf /tmp/backup_$DATE.tar.gz /app/data
docker cp ai-tools-backend:/tmp/backup_$DATE.tar.gz ./backups/
```

## 📞 支持

如果遇到问题，请：

1. 查看日志: `./deploy.sh logs`
2. 检查健康状态: `./deploy.sh health`
3. 查看本文档的故障排除部分
4. 提交 Issue 到项目仓库

## 🔄 更新部署

```bash
# 拉取最新代码
git pull origin main

# 重新构建和部署
./deploy.sh deploy

# 或者分步执行
./deploy.sh down
./deploy.sh build
./deploy.sh up
```

## 📋 访问地址

- 生产环境: https://ai.jarvismedical.asia
- 前端服务: http://localhost:3003
- 后端服务: http://localhost:8003
- 健康检查: https://ai.jarvismedical.asia/health
