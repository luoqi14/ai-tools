# AI 工具集 部署指南

## 架构重构说明

项目已经重构为符合 Next.js 最佳实践的架构：

### 主要改进

1. **环境变量配置**：使用 `NEXT_PUBLIC_API_BASE_URL` 配置后端地址
2. **Next.js API Routes**：创建 API 代理，避免 CORS 问题
3. **相对路径调用**：前端使用 `/api/*` 相对路径
4. **类型安全**：增强 TypeScript 类型定义
5. **生产环境支持**：支持不同环境的配置

## 环境变量配置

### 开发环境

创建 `frontend/.env.local`：

```bash
# 后端API地址
NEXT_PUBLIC_API_BASE_URL=http://localhost:8003
```

### 生产环境

创建 `frontend/.env.production`：

```bash
# 生产环境配置
NEXT_PUBLIC_API_BASE_URL=https://your-production-domain.com
BFL_API_KEY=your_production_bfl_api_key
```

## API 架构

### Next.js API Routes (代理模式)

所有前端 API 调用都通过 Next.js API Routes 代理到后端：

```
前端调用: /api/tools
        ↓
Next.js API Route: /api/tools/route.ts
        ↓
后端实际地址: http://localhost:8003/api/tools
```

### API 路由结构

```
frontend/src/app/api/
├── tools/
│   ├── route.ts                 # GET /api/tools
│   ├── [id]/route.ts           # GET /api/tools/:id
│   └── categories/route.ts     # GET /api/tools/categories
├── image-generation/
│   ├── generate/route.ts       # POST /api/image-generation/generate
│   └── status/[taskId]/route.ts # GET /api/image-generation/status/:taskId
└── bing-image/
    └── route.ts                # GET /api/bing-image
```

## 开发环境启动

1. **设置环境变量**

```bash
cd frontend
cp .env.example .env.local
# 编辑 .env.local 设置正确的后端地址
```

2. **启动服务**

```bash
# 使用项目启动脚本
./start.sh

# 或手动启动
cd backend && python run.py &
cd frontend && npm run dev &
```

## 生产环境部署

### 1. 服务器配置

#### 后端部署 (Flask)

```bash
# 安装依赖
cd backend
pip install -r requirements.txt

# 设置环境变量
export BFL_API_KEY=your_bfl_api_key
export PORT=8003

# 生产环境启动
gunicorn -w 4 -b 0.0.0.0:8003 run:app
```

#### 前端部署 (Next.js)

```bash
cd frontend

# 设置生产环境变量
export NEXT_PUBLIC_API_BASE_URL=https://your-domain.com

# 构建项目
npm run build

# 启动生产服务器
npm run start
```

### 2. Nginx 反向代理配置

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端服务
    location / {
        proxy_pass http://localhost:3003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # 直接后端API（可选，用于外部调用）
    location /direct-api/ {
        proxy_pass http://localhost:8003/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 3. Docker 部署

#### Dockerfile.frontend

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3003

CMD ["npm", "start"]
```

#### Dockerfile.backend

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8003

CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:8003", "run:app"]
```

#### docker-compose.yml

```yaml
version: "3.8"

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8003:8003"
    environment:
      - BFL_API_KEY=${BFL_API_KEY}
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3003:3003"
    environment:
      - NEXT_PUBLIC_API_BASE_URL=http://backend:8003
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
    restart: unless-stopped
```

## 环境变量说明

| 变量名                     | 描述                       | 示例值                  |
| -------------------------- | -------------------------- | ----------------------- |
| `NEXT_PUBLIC_API_BASE_URL` | 后端 API 基础地址          | `http://localhost:8003` |
| `BFL_API_KEY`              | Black Forest Labs API 密钥 | `your_api_key_here`     |
| `PORT`                     | 后端端口                   | `8003`                  |

## 故障排查

### 1. API 调用失败

- 检查环境变量 `NEXT_PUBLIC_API_BASE_URL` 是否正确
- 确认后端服务运行在正确端口
- 检查网络连接和防火墙设置

### 2. 图像生成失败

- 确认 `BFL_API_KEY` 已正确设置
- 检查后端日志中的 API 调用错误

### 3. 背景图片加载失败

- 检查必应 API 是否可访问
- 查看浏览器网络面板的错误信息

## 性能优化建议

1. **使用 CDN**: 将静态资源部署到 CDN
2. **启用压缩**: 在 Nginx 中启用 gzip 压缩
3. **缓存策略**: 对 API 响应设置适当的缓存头
4. **图片优化**: 使用 WebP 格式和懒加载

## 安全建议

1. **HTTPS**: 生产环境必须使用 HTTPS
2. **API 密钥**: 不要将敏感信息提交到代码仓库
3. **CORS**: 后端正确配置 CORS 策略
4. **速率限制**: 对 API 端点实施速率限制
