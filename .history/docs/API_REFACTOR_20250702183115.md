# API 重构说明

## 重构前后对比

### 重构前的问题

1. **硬编码端口**: 前端硬编码了 `localhost:5000`，但后端实际运行在 `8003`
2. **CORS 问题**: 直接跨域调用容易遇到 CORS 限制
3. **部署困难**: 写死 localhost 无法部署到服务器
4. **配置分散**: API 地址分散在各个组件中

### 重构后的改进

#### 1. 环境变量统一管理

```typescript
// 重构前
const API_URL = "http://localhost:5000/api/image-generation/generate";

// 重构后
const API_BASE_URL = process.env.NEXT_PUBLIC_API_BASE_URL
  ? `${process.env.NEXT_PUBLIC_API_BASE_URL}/api`
  : "/api";
```

#### 2. Next.js API Routes 代理模式

```typescript
// 前端调用 (相对路径)
await fetch("/api/image-generation/generate", {
  method: "POST",
  body: formData,
});

// Next.js API Route (代理到后端)
// frontend/src/app/api/image-generation/generate/route.ts
const response = await fetch(`${BACKEND_URL}/api/image-generation/generate`, {
  method: "POST",
  body: formData,
});
```

#### 3. 类型安全的 API 调用

```typescript
// 重构前
const formData = new FormData();
formData.append("prompt", prompt);
// ... 手动添加表单数据

// 重构后
const request: ImageGenerationRequest = {
  prompt,
  aspect_ratio: aspectRatio,
  steps: steps[0],
  // ... 类型安全的对象
};
await api.generateImage(request);
```

## API 调用流程

### 工具列表 API

```
前端组件 → api.getTools() → /api/tools → Next.js Route → Backend:8003/api/tools
```

### 图像生成 API

```
ImageGenerator → api.generateImage() → /api/image-generation/generate → Next.js Route → Backend:8003/api/image-generation/generate
```

### 背景图片 API

```
HomePage → api.getBingImageUrl() → /api/bing-image → Next.js Route → Backend:8003/api/bing-image
```

## 配置变更

### 环境变量文件

```bash
# .env.local (开发环境)
NEXT_PUBLIC_API_BASE_URL=http://localhost:8003

# .env.production (生产环境)
NEXT_PUBLIC_API_BASE_URL=https://your-domain.com
```

### Next.js 配置变更

```typescript
// next.config.ts
// 删除了 rewrites 配置，改用 API Routes
const nextConfig: NextConfig = {
  // 移除了硬编码的proxy配置
  // async rewrites() { ... } // 已删除

  // 添加了环境变量配置
  env: {
    NEXT_PUBLIC_API_BASE_URL: process.env.NEXT_PUBLIC_API_BASE_URL,
  },
};
```

## 新增的 API 类型定义

```typescript
// 图像生成请求类型
export interface ImageGenerationRequest {
  prompt: string;
  aspect_ratio?: string;
  output_format?: string;
  steps?: number;
  guidance?: number;
  safety_tolerance?: number;
  seed?: string;
  input_image?: File;
}

// 任务状态类型
export interface ImageGenerationTask {
  id: string;
  status: "pending" | "running" | "completed" | "failed";
  result?: { image_url: string };
  error?: string;
}
```

## 错误处理改进

### 重构前

```typescript
// 简单的错误处理
catch (error) {
  showAlert("error", "网络错误，请检查后端服务");
}
```

### 重构后

```typescript
// 详细的错误处理
catch (error) {
  console.error("生成失败:", error);
  setIsGenerating(false);
  showAlert(
    "error",
    error instanceof Error ? error.message : "网络错误，请检查后端服务"
  );
}
```

## 部署优势

1. **本地开发**: 自动使用相对路径，通过 API Routes 代理
2. **生产部署**: 通过环境变量配置真实的后端地址
3. **Docker 部署**: 容器间通信使用内部网络地址
4. **CDN 部署**: 前端可以部署到 CDN，API 调用不受影响

## 兼容性说明

- ✅ 向后兼容：后端 API 无需修改
- ✅ 开发体验：本地开发无需额外配置
- ✅ 生产部署：支持各种部署场景
- ✅ 类型安全：完整的 TypeScript 支持
