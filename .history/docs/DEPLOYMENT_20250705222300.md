# AI 工具集 部署指南

## 🏗️ 架构说明

项目支持两种部署架构：

### 1. 静态前端架构 (推荐)

```
静态前端 (Next.js导出) → 直接调用 → 后端API (Flask)
```

- ✅ **前端**: 纯静态文件，可部署到任何静态服务器
- ✅ **后端**: 独立运行，提供 API 服务
- ✅ **无需 Node.js 服务器**: 前端完全静态化

### 2. 传统架构

```
前端 (Next.js服务) → API Routes代理 → 后端API (Flask)
```

- 需要 Node.js 服务器运行前端
- 通过 API Routes 代理避免 CORS 问题

## 🚀 静态部署 (推荐)

### 1. 前端构建

```bash
cd frontend

# 设置后端API地址
export NEXT_PUBLIC_API_BASE_URL=https://your-backend-domain.com

# 构建静态文件
npm run build

# 静态文件在 out/ 目录
ls out/
```

### 2. 前端部署选项

#### 选项 1: 静态服务器

```bash
# 使用 serve
npx serve out

# 使用 Python
cd out && python -m http.server 3000

# 使用 Nginx
# 将 out/ 目录内容复制到 /var/www/html/
```

#### 选项 2: CDN/静态托管

- **Vercel**: `vercel --prod`
- **Netlify**: 拖放 `out/` 文件夹
- **GitHub Pages**: 上传到 gh-pages 分支
- **OSS/S3**: 上传静态文件

### 3. 后端部署

```bash
cd backend

# 设置环境变量
export BFL_API_KEY=your_api_key
export CORS_ORIGINS=https://your-frontend-domain.com

# 生产环境启动
gunicorn -w 4 -b 0.0.0.0:8003 run:app
```

## 🔧 环境配置

### 前端环境变量

```bash
# .env.local (本地开发)
NEXT_PUBLIC_API_BASE_URL=http://localhost:8003

# .env.production (生产环境)
NEXT_PUBLIC_API_BASE_URL=https://your-backend-domain.com
```

### 后端环境变量

```bash
# 生产环境
export CORS_ORIGINS=https://your-frontend-domain.com,https://www.your-frontend-domain.com
export BFL_API_KEY=your_api_key
export PORT=8003
```

## 📋 部署脚本

### 前端部署脚本 (deploy-frontend.sh)

```bash
#!/bin/bash
echo "🚀 部署前端..."

# 设置生产环境API地址
export NEXT_PUBLIC_API_BASE_URL=https://your-backend-domain.com

# 构建
npm run build

# 部署到服务器 (示例)
rsync -avz out/ user@server:/var/www/html/

echo "✅ 前端部署完成！"
```

### 后端部署脚本 (deploy-backend.sh)

```bash
#!/bin/bash
echo "🚀 部署后端..."

# 安装依赖
pip install -r requirements.txt

# 设置环境变量
export CORS_ORIGINS=https://your-frontend-domain.com
export BFL_API_KEY=your_api_key

# 启动服务
gunicorn -w 4 -b 0.0.0.0:8003 run:app

echo "✅ 后端部署完成！"
```

## 🌐 Nginx 配置

### 静态前端配置

```nginx
server {
    listen 80;
    server_name your-frontend-domain.com;

    root /var/www/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静态资源缓存
    location /_next/static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 后端 API 配置

```nginx
server {
    listen 80;
    server_name your-backend-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS headers (可选，后端已配置)
        add_header Access-Control-Allow-Origin *;
    }
}
```

## 🐳 Docker 部署

### 静态前端 Dockerfile

```dockerfile
FROM nginx:alpine

# 复制构建好的静态文件
COPY out/ /usr/share/nginx/html/

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

### 后端 Dockerfile

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8003

CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:8003", "run:app"]
```

### docker-compose.yml

```yaml
version: "3.8"

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8003:8003"
    environment:
      - BFL_API_KEY=${BFL_API_KEY}
      - CORS_ORIGINS=https://your-frontend-domain.com
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped
```

## 🛠️ 传统部署 (Next.js 服务)

如果需要使用 Next.js 服务器模式：

### 前端部署

```bash
cd frontend

# 设置生产环境变量
export NEXT_PUBLIC_API_BASE_URL=https://your-domain.com

# 构建项目
npm run build

# 启动生产服务器
npm run start
```

### Nginx 反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端服务
    location / {
        proxy_pass http://localhost:3003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # 直接后端API（可选，用于外部调用）
    location /direct-api/ {
        proxy_pass http://localhost:8003/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 🔍 故障排除

### 1. CORS 问题

```bash
# 检查后端CORS配置
export CORS_ORIGINS=https://your-frontend-domain.com
```

### 2. API 连接失败

```bash
# 检查环境变量
echo $NEXT_PUBLIC_API_BASE_URL

# 检查后端服务状态
curl http://localhost:8003/health
```

### 3. 静态文件 404

```bash
# 确保静态文件路径正确
ls frontend/out/
```

## 📊 部署选择建议

### 静态部署 (推荐)

- ✅ 成本低廉 (免费静态托管)
- ✅ 性能优秀 (CDN 加速)
- ✅ 高可用性 (无服务器故障)
- ✅ 易于扩展

### 传统部署

- 需要 Node.js 服务器
- 适合复杂的 SSR 需求
- 需要更多服务器资源

## 🎯 快速开始

```bash
# 1. 静态部署
cd frontend
export NEXT_PUBLIC_API_BASE_URL=https://your-api.com
npm run build
# 将 out/ 目录部署到静态服务器

# 2. 后端部署
cd backend
export BFL_API_KEY=your_key
export CORS_ORIGINS=https://your-frontend.com
gunicorn -w 4 -b 0.0.0.0:8003 run:app
```

完整的部署指南！根据你的需求选择静态部署或传统部署方式。
