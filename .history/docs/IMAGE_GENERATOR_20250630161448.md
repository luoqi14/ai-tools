# AI 图像生成工具使用说明

## 功能概述

AI 图像生成工具基于 [Black Forest Labs Flux Kontext](https://docs.bfl.ai/api-reference/tasks/edit-or-create-an-image-with-flux-kontext-pro) 官方 API，提供统一的文生图和图生图功能，支持高质量的图像生成和编辑。

## 功能特性

### 1. 智能模式切换

- **文生图模式**: 通过文字描述生成图像
- **图生图模式**: 上传图片后自动切换为图像编辑模式
- **统一界面**: 无需手动切换，根据是否上传图片自动判断

### 2. 专业参数控制

- **纵横比选择**: 1:1, 4:3, 3:4, 16:9, 9:16, 21:9, 9:21
- **输出格式**: JPEG/PNG
- **安全级别**: 内容安全检测

### 3. 现代化 UI 设计

- **shadcn/ui 组件**: 专业的 UI 组件库
- **响应式设计**: 移动端和桌面端完美适配
- **任务状态追踪**: 实时显示生成进度

## 环境配置

### 1. 获取 BFL API 密钥

1. 访问 [Black Forest Labs](https://docs.bfl.ai/) 注册账号
2. 在控制台获取 API 密钥

### 2. 设置环境变量

```bash
# 在backend目录下设置环境变量
export BFL_API_KEY="your_bfl_api_key_here"

# 或者在.env文件中添加（需要手动创建）
echo "BFL_API_KEY=your_bfl_api_key_here" > .env
```

## 使用方法

### 启动服务

```bash
# 启动完整服务
./start.sh

# 或分别启动
# 后端 (端口8003)
cd backend && source venv/bin/activate && python run.py

# 前端 (端口3003)
cd frontend && npm run dev
```

### 访问界面

1. 打开浏览器访问 `http://localhost:3003`
2. 点击"AI 图像生成"工具卡片
3. 输入提示词描述
4. 可选：上传图片启用编辑模式
5. 调节高级设置
6. 点击生成按钮

## API 接口

### 1. 统一生成接口

```
POST /api/image-generation/generate

参数:
- prompt: 文字描述 (必需)
- aspect_ratio: 纵横比 (可选，默认1:1)
- output_format: 输出格式 (可选，默认jpeg)
- input_image: base64图片数据 (可选，有此参数则为图生图模式)
- safety_tolerance: 安全级别 (可选，默认2)
- prompt_upsampling: 提示词增强 (可选，默认false)

返回:
{
  "success": true,
  "data": {
    "task_id": "uuid",
    "polling_url": "status_endpoint"
  }
}
```

### 2. 任务状态查询

```
GET /api/image-generation/status/{task_id}

返回:
{
  "success": true,
  "data": {
    "status": "Ready|Task-Pending|Task-Running|Error",
    "result": {
      "images": [{"url": "image_url", "width": 1024, "height": 1024}],
      "seed": 12345,
      "has_nsfw_concepts": [false]
    }
  }
}
```

### 3. 图片上传接口

```
POST /api/image-generation/upload

文件上传，返回base64数据供生成接口使用

返回:
{
  "success": true,
  "data": {
    "base64_image": "data:image/jpeg;base64,/9j/4AAQ...",
    "file_size": 123456,
    "content_type": "image/jpeg"
  }
}
```

## 技术架构

### 后端

- **框架**: Flask + 模块化蓝图
- **AI 服务**: Black Forest Labs Flux Kontext Pro 官方 API
- **文件处理**: base64 编码，支持多种图片格式
- **异步处理**: 任务队列 + 状态轮询

### 前端

- **框架**: Next.js 15.3.4 + React 19
- **UI 组件**: shadcn/ui + Tailwind CSS
- **状态管理**: React Hooks
- **网络**: fetch API + 轮询机制

### 设计理念

- **简洁高效**: 去除玻璃拟态，采用清晰的卡片布局
- **智能交互**: 自动模式识别，无需手动切换
- **专业体验**: 状态追踪、错误处理、加载指示

## 目录结构

```
backend/app/routes/
├── image_generation.py    # 独立的图像生成模块
├── tools.py              # 工具列表管理
└── main.py               # 主路由

frontend/src/
├── app/image-generator/   # 图像生成页面
├── components/tools/      # 图像生成组件
└── components/ui/         # shadcn UI组件
```

## 故障排除

### 1. API 密钥错误

```
错误: BFL API密钥未配置
解决: 检查环境变量BFL_API_KEY是否正确设置
```

### 2. 任务超时

```
错误: 任务超时，请重试
解决:
- 检查网络连接
- 简化提示词内容
- 确认API服务状态
```

### 3. 图片上传失败

```
错误: 文件上传失败
解决: 确认文件格式支持（PNG, JPG, JPEG, GIF, BMP, WEBP）
```

### 4. 生成质量问题

```
优化建议:
- 使用具体、详细的描述词
- 避免冲突或矛盾的指令
- 合理选择纵横比
```

## 最佳实践

### 提示词编写

- **具体描述**: "一个红色的苹果在木桌上" 比 "苹果" 更好
- **风格指定**: 添加艺术风格如 "photorealistic", "oil painting"
- **质量关键词**: 使用 "high quality", "detailed", "8k"

### 图生图技巧

- **清晰原图**: 上传高质量、清晰的原始图片
- **明确指令**: 具体说明要修改的部分
- **保持一致**: 修改指令应与原图风格协调

## 更新日志

### v2.0.0 (2025-01-27)

- ✅ 迁移至 Black Forest Labs 官方 API
- ✅ 合并文生图和图生图功能
- ✅ 重新设计 UI，使用 shadcn/ui 组件
- ✅ 模块化后端架构
- ✅ 异步任务处理和状态轮询
- ✅ 去除玻璃拟态设计，采用专业简洁风格

### v1.0.0 (2025-01-27)

- ✅ 初始版本基于 fal.ai 代理服务
- ✅ 磨砂玻璃拟态 UI 设计（已废弃）
